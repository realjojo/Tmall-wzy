<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="include/admin/adminHeader::html('订单管理')" ></head>
<body>
<div th:replace="include/admin/adminNavigator::html" ></div>
<script>
    $(function() {
        var vue = new Vue({
            el: '#workingArea',
            data: {
                order_uri: 'orders',
                orderitem_uri: 'orderitems',
                beans: [],
                bean: { id: 0, name: ''},
                pagination: {}
            },
            mounted:function(){
                this.list(0);
            },
            methods: {
                list: function(start) {
                    let url = this.orderitem_uri + "/list?start=" + start;
                    axios.get(url).then(function(response) {
                        vue.pagination = response.data;
                        let arr = response.data.content.reverse();
                        let arr1 = [];
                        arr.forEach(function (object) {
                           arr1.push(object.order.id);
                        });
                        let orderId = Array.from(new Set(arr1));
                        let orderArr = orderId;
                        for(let i = 0; i < orderId.length; i++) {
                            let product_num = 0;
                            let product_price = 0;
                            let oneOrder = [];
                            arr.forEach(function (obj) {
                                if(obj.order.id == orderId[i]) {
                                    oneOrder.push(obj);
                                }
                            });
                            oneOrder.forEach(function (one) {
                                product_num = product_num + one.number;
                                product_price = product_price + one.product.promotePrice * one.number;
                            });
                            orderArr[i] = oneOrder[0];
                            orderArr[i].id = orderArr[i].order.id;
                            orderArr[i].showDetail = false;
                            orderArr[i].priceSum = product_price;
                            orderArr[i].numberSum = product_num;
                            orderArr[i].orderItems = oneOrder;
                            orderArr[i].order.createDate = timestamp2Date(orderArr[i].order.createDate);
                            orderArr[i].order.payDate = timestamp2Date(orderArr[i].order.payDate);
                        }
                        vue.beans = orderArr;
                        console.log(vue.beans);
                    });
                },
                getOrderItem: function(i) {
                    let show = vue.beans[i].showDetail;
                    let obj = vue.beans[i];
                    obj.showDetail = !show;
                    Vue.set(vue.beans, i, obj);
                },
                jump: function(page) {
                    jump(page,vue);
                },
                jumpByNumber: function(start) {
                    jumpByNumber(start,vue);
                }
            }
        });

        function timestamp2Date(timestamp) {
            let date = new Date(timestamp),
                y = date.getFullYear(),
                m = date.getMonth() + 1,
                d = date.getDate();
            return y + "-" + (m < 10 ? "0" + m : m) + "-" + (d < 10 ? "0" + d : d) + " " + date.toTimeString().substr(0, 8);
        }

    });

</script>
<div id="workingArea" >
    <h1 class="label label-info" >订单管理</h1>
    <br>
    <br>
    <div class="listDataTableDiv">
        <table class="table table-striped table-bordered table-hover table-condensed">
            <thead>
                <tr class="success">
                    <th>ID</th>
                    <th>状态</th>
                    <th>金额</th>
                    <th width="100px">商品数量</th>
                    <th width="100px">买家名称</th>
                    <th>创建时间</th>
                    <th>支付时间</th>
                    <th>发货时间</th>
                    <th>确认收货时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <template v-for="(bean, index) in beans">
                    <tr>
                        <td>{{bean.id}}</td>
                        <td>{{bean.order.status}}</td>
                        <td>{{bean.priceSum}}</td>
                        <td>{{bean.numberSum}}</td>
                        <td>{{bean.user.name}}</td>
                        <td>{{bean.order.createDate}}</td>
                        <td>{{bean.order.payDate}}</td>
                        <td>{{bean.order.deliverDate}}</td>
                        <td>{{bean.order.confirmDate}}</td>
                        <td>
                            <button class="orderPageCheckOrderItems btn btn-primary btn-xs" @click="getOrderItem(index)">查看详情</button>
                            <button class="btn btn-primary btn-xs">发货</button>
                        </td>
                    </tr>
                    <tr v-show="bean.showDetail">
                        <td colspan="10" align="center">
                            <div class="orderPageOrderItem">
                                <table width="800px" align="center" class="orderPageOrderItemTable">
                                    <tr v-for="item in bean.orderItems">
                                        <td align="left">
                                            <img width="40px" height="40px" src="img/productsingle/{{item.product.id}}_0single.jpg">
                                        </td>
                                        <td>
                                            <!--todo:产品链接跳转-->
                                            <a href="foreproduct?pid={{item.product.id}}"><span>{{item.product.name}}</span></a>
                                        </td>
                                        <td align="right">
                                            <span class="text-muted">{{item.number}}个</span>
                                        </td>
                                        <td align="right">
                                            <span class="text-muted">单价：￥{{item.product.promotePrice}}</span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
    <div th:replace="include/admin/adminPage::html" ></div>
</div>
<div th:replace="include/admin/adminFooter::html" ></div>
</body>
</html>